<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>سامانه قاضی هوشمند</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="container">
    <header>
      <h1>سامانه قاضی هوشمند</h1>
      <p class="subtitle">گردآوری و تبادل اطلاعات بین شاکی و متشاکی تا صدور رای</p>
    </header>

    <section class="judge-section">
      <h2>نتیجه قاضی</h2>
      {% if case.verdict %}
        <div class="judge-box verdict">
          <div class="label">رای نهایی:</div>
          <div class="content">{{ case.verdict }}</div>
        </div>
      {% elif last_request %}
        <div class="judge-box request">
          <div class="label">درخواست از {{ 'شاکی' if last_request.target=='plaintiff' else 'متشاکی' }}:</div>
          <div class="content">{{ last_request.message }}</div>
        </div>
      {% else %}
        <div class="judge-box neutral">
          <div class="content">برای دریافت نتیجه اولیه، از دکمه «ارزیابی قاضی» استفاده کنید.</div>
        </div>
      {% endif %}

      <form class="judge-actions" method="post" action="{{ url_for('judge_evaluate') }}">
        <button type="submit" class="btn primary">ارزیابی قاضی</button>
      </form>
      <form class="judge-actions" method="post" action="{{ url_for('judge_reset') }}">
        <button type="submit" class="btn subtle" title="شروع پرونده جدید">شروع پرونده جدید</button>
      </form>
    </section>

    <section class="inputs-section">
      <div class="columns two">
        <div class="col card">
          <h3>ورودی شاکی</h3>
          <form method="post" action="{{ url_for('submit_plaintiff') }}" enctype="multipart/form-data" class="stack">
            <label for="plaintiff_text">توضیحات</label>
            <textarea id="plaintiff_text" name="plaintiff_text" rows="4" placeholder="شرح ادعا یا توضیحات تکمیلی"></textarea>

            <label for="plaintiff_link">لینک یا نشانی مدرک (اختیاری)</label>
            <input id="plaintiff_link" name="plaintiff_link" type="url" placeholder="https://...">

            <label for="plaintiff_file">فایل ضمیمه (اختیاری)</label>
            <input id="plaintiff_file" name="plaintiff_file" type="file" accept=".txt,.pdf,.doc,.docx">
            <small>فرمت‌های مجاز: TXT, PDF, DOC, DOCX (حداکثر 16 مگابایت)</small>

            <button type="submit" class="btn">ارسال برای پرونده</button>
          </form>
        </div>

        <div class="col card">
          <h3>ورودی متشاکی</h3>
          <form method="post" action="{{ url_for('submit_defendant') }}" enctype="multipart/form-data" class="stack">
            <label for="defendant_text">توضیحات</label>
            <textarea id="defendant_text" name="defendant_text" rows="4" placeholder="پاسخ یا توضیحات تکمیلی"></textarea>

            <label for="defendant_link">لینک یا نشانی مدرک (اختیاری)</label>
            <input id="defendant_link" name="defendant_link" type="url" placeholder="https://...">

            <label for="defendant_file">فایل ضمیمه (اختیاری)</label>
            <input id="defendant_file" name="defendant_file" type="file" accept=".txt,.pdf,.doc,.docx">
            <small>فرمت‌های مجاز: TXT, PDF, DOC, DOCX (حداکثر 16 مگابایت)</small>

            <button type="submit" class="btn">ارسال برای پرونده</button>
          </form>
        </div>
      </div>
    </section>

    <section class="history-section">
      <h2>تاریخچه</h2>
      <div class="columns two history-columns">
        <div class="col history-col right-side">
          <h3>شاکی</h3>
          {% if case.plaintiff_submissions %}
            {% for item in case.plaintiff_submissions %}
              <div class="item-box">
                <div class="meta">{{ item.ts }}</div>
                <div class="text">{{ item.text or '—' }}</div>
                {% if item.link %}
                  <div class="link"><a href="{{ item.link }}" target="_blank" rel="noopener">مشاهده مدرک</a></div>
                {% endif %}
                {% if item.file %}
                  <div class="file-info">
                    <strong>فایل ضمیمه:</strong> {{ item.file.filename }}
                    <div class="file-content">
                      <details>
                        <summary>مشاهده محتوای فایل</summary>
                        <pre>{{ item.file.content[:500] }}{% if item.file.content|length > 500 %}...{% endif %}</pre>
                      </details>
                    </div>
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <div class="empty">هنوز ورودی ثبت نشده است.</div>
          {% endif %}
        </div>
        <div class="col history-col left-side">
          <h3>متشاکی</h3>
          {% if case.defendant_submissions %}
            {% for item in case.defendant_submissions %}
              <div class="item-box">
                <div class="meta">{{ item.ts }}</div>
                <div class="text">{{ item.text or '—' }}</div>
                {% if item.link %}
                  <div class="link"><a href="{{ item.link }}" target="_blank" rel="noopener">مشاهده مدرک</a></div>
                {% endif %}
                {% if item.file %}
                  <div class="file-info">
                    <strong>فایل ضمیمه:</strong> {{ item.file.filename }}
                    <div class="file-content">
                      <details>
                        <summary>مشاهده محتوای فایل</summary>
                        <pre>{{ item.file.content[:500] }}{% if item.file.content|length > 500 %}...{% endif %}</pre>
                      </details>
                    </div>
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <div class="empty">هنوز ورودی ثبت نشده است.</div>
          {% endif %}
        </div>
      </div>
    </section>

    <footer>
      <small>نسخه آزمایشی — برای دیپلوی، کلید <code>ANTHROPIC_API_KEY</code> را در Render تنظیم کنید.</small>
    </footer>
  </div>
</body>
</html>